generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["audit", "bindx", "contact", "core", "ops", "pay"]
}

model Tenant {
  id            String         @id @default(uuid()) @db.Uuid
  name          String
  slug          String         @unique
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  echeqs        Echeq[]
  batchJobs           BatchJob[]
  contactEvents       ContactEvent[]
  contactRuns         ContactRun[]
  scheduledCallbacks  ScheduledCallback[]
  sequences           Sequence[]
  asociados     Asociado[]
  customerCuits CustomerCuit[]
  customers     Customer[]
  invoices      Invoice[]
  policyRules   PolicyRule[]
  promises      Promise[]
  users         User[]
  decisionItems DecisionItem[]

  @@map("tenants")
  @@schema("core")
}

model User {
  id                    String         @id @default(uuid()) @db.Uuid
  tenantId              String         @map("tenant_id") @db.Uuid
  codigoUnico           String         @map("codigo_unico")
  nombre                String
  apellido              String
  email                 String
  passwordHash          String?        @map("password_hash")
  perfil                String
  activo                Boolean        @default(true)
  createdAt             DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  batchJobs             BatchJob[]
  tenant                Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  decisionItemsCreated  DecisionItem[] @relation("CreatedBy")
  decisionItemsResolved DecisionItem[] @relation("ResolvedBy")

  @@unique([tenantId, email])
  @@unique([tenantId, codigoUnico])
  @@map("users")
  @@schema("core")
}

model Customer {
  id               String         @id @default(uuid()) @db.Uuid
  tenantId         String         @map("tenant_id") @db.Uuid
  codigoUnico      String         @map("codigo_unico")
  codigoVenta      String         @default("000") @map("codigo_venta")
  razonSocial      String         @map("razon_social")
  email            String
  passwordHash     String?        @map("password_hash")
  telefono         String?
  activo           Boolean        @default(true)
  accesoHabilitado Boolean        @default(false) @map("acceso_habilitado")
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  echeqs           Echeq[]
  contactEvents      ContactEvent[]
  contactRuns        ContactRun[]
  customerCuits     CustomerCuit[]
  scheduledCallbacks ScheduledCallback[]
  tenant             Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices           Invoice[]

  @@unique([tenantId, codigoUnico])
  @@unique([tenantId, email])
  @@map("customers")
  @@schema("core")
}

model CustomerCuit {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  customerId  String   @map("customer_id") @db.Uuid
  cuit        String
  razonSocial String?  @map("razon_social")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, cuit])
  @@index([customerId])
  @@map("customer_cuits")
  @@schema("core")
}

model Invoice {
  id                  String               @id @default(uuid()) @db.Uuid
  tenantId            String               @map("tenant_id") @db.Uuid
  customerId          String               @map("customer_id") @db.Uuid
  numero              String
  monto               Int
  fechaVto            DateTime             @map("fecha_vto") @db.Date
  estado              String
  createdAt           DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  contactEvents       ContactEvent[]
  contactRuns         ContactRun[]
  customer            Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  scheduledCallbacks  ScheduledCallback[]
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  promises            Promise[]
  paymentApplications PaymentApplication[]

  @@unique([tenantId, numero])
  @@index([tenantId, customerId])
  @@index([fechaVto])
  @@index([estado])
  @@map("invoices")
  @@schema("core")
}

model Promise {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  invoiceId String   @map("invoice_id") @db.Uuid
  amount    Int?
  dueDate   DateTime @map("due_date") @db.Date
  channel   String
  status    String
  reason    String?
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([dueDate])
  @@map("promises")
  @@schema("core")
}

model PolicyRule {
  tenantId  String   @map("tenant_id") @db.Uuid
  key       String
  valueJson Json     @map("value_json")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([tenantId, key])
  @@map("policy_rules")
  @@schema("core")
}

model Asociado {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @map("tenant_id") @db.Uuid
  codigoUnico String    @map("codigo_unico")
  nombre      String
  apellido    String
  dni         String
  email       String?
  telefono    String?
  direccion   String?
  fechaAlta   DateTime? @map("fecha_alta") @db.Date
  activo      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, codigoUnico])
  @@unique([tenantId, dni])
  @@index([tenantId, activo])
  @@map("asociados")
  @@schema("core")
}

model Payment {
  id           String               @id @default(uuid()) @db.Uuid
  tenantId     String               @map("tenant_id") @db.Uuid
  sourceSystem String               @map("source_system")
  method       String
  status       String
  settledAt    DateTime?            @map("settled_at") @db.Timestamptz(6)
  externalRef  String?              @map("external_ref")
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime             @updatedAt @map("updated_at") @db.Timestamptz(6)
  applications PaymentApplication[]

  @@index([tenantId, status])
  @@index([externalRef])
  @@map("payments")
  @@schema("pay")
}

model PaymentApplication {
  id                     String   @id @default(uuid()) @db.Uuid
  tenantId               String   @map("tenant_id") @db.Uuid
  paymentId              String   @map("payment_id") @db.Uuid
  invoiceId              String   @map("invoice_id") @db.Uuid
  amount                 Int
  isAuthoritative        Boolean  @default(false) @map("is_authoritative")
  appliedAt              DateTime @map("applied_at") @db.Timestamptz(6)
  externalApplicationRef String?  @map("external_application_ref")
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  invoice                Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  payment                Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([tenantId, paymentId])
  @@index([tenantId, invoiceId])
  @@index([isAuthoritative])
  @@map("payment_applications")
  @@schema("pay")
}

model Echeq {
  id                String    @id @default(uuid()) @db.Uuid
  tenantId          String    @map("tenant_id") @db.Uuid
  customerId        String    @map("customer_id") @db.Uuid
  number            String
  amount            Int
  statusOperativo   String    @map("status_operativo")
  statusLiquidacion String    @map("status_liquidacion")
  acceptedAt        DateTime? @map("accepted_at") @db.Timestamptz(6)
  settledAt         DateTime? @map("settled_at") @db.Timestamptz(6)
  rejectedReason    String?   @map("rejected_reason")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  customer          Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, number])
  @@index([tenantId, statusOperativo, statusLiquidacion])
  @@index([tenantId, customerId])
  @@map("echeqs")
  @@schema("bindx")
}

model Sequence {
  id             String       @id @default(uuid()) @db.Uuid
  tenantId       String       @map("tenant_id") @db.Uuid
  name           String
  definitionJson Json         @map("definition_json")
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  runs           ContactRun[]
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("sequences")
  @@schema("contact")
}

model ContactRun {
  id         String         @id @default(uuid()) @db.Uuid
  tenantId   String         @map("tenant_id") @db.Uuid
  invoiceId  String         @map("invoice_id") @db.Uuid
  customerId String?        @map("customer_id") @db.Uuid
  sequenceId String?        @map("sequence_id") @db.Uuid
  state      String
  step       Int            @default(0)
  nextAt     DateTime?      @map("next_at") @db.Timestamptz(6)
  createdAt  DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  events     ContactEvent[]
  customer   Customer?      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice    Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  sequence   Sequence?      @relation(fields: [sequenceId], references: [id])
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, state])
  @@index([nextAt])
  @@map("runs")
  @@schema("contact")
}

model ContactEvent {
  id                String      @id @default(uuid()) @db.Uuid
  tenantId          String      @map("tenant_id") @db.Uuid
  runId             String?     @map("run_id") @db.Uuid
  batchId           String?     @map("batch_id") @db.Uuid
  invoiceId         String?     @map("invoice_id") @db.Uuid
  customerId        String      @map("customer_id") @db.Uuid
  channel           String
  direction         String
  isManual          Boolean     @default(false) @map("is_manual")
  sentBy            String?     @map("sent_by") @db.Uuid
  templateId        String?     @map("template_id") @db.Uuid
  messageText       String?     @map("message_text")
  mediaUrl          String?     @map("media_url")
  transcription     String?
  callDuration      Int?        @map("call_duration")
  callSummary       String?     @map("call_summary")
  payload           Json?
  status            String
  externalMessageId String?     @map("external_message_id")
  errorReason       String?     @map("error_reason")
  ts                DateTime    @default(now()) @db.Timestamptz(6)
  batch                  BatchJob?          @relation(fields: [batchId], references: [id])
  customer               Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice                Invoice?           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  run                    ContactRun?        @relation(fields: [runId], references: [id], onDelete: Cascade)
  scheduledCallbacksFrom  ScheduledCallback[] @relation("ScheduledCallbackSource")
  tenant                 Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, runId])
  @@index([ts])
  @@index([batchId])
  @@map("events")
  @@schema("contact")
}

model BatchJob {
  id            String         @id @default(uuid()) @db.Uuid
  tenantId      String         @map("tenant_id") @db.Uuid
  createdBy     String         @map("created_by") @db.Uuid
  channel       String
  templateId    String?        @map("template_id") @db.Uuid
  totalMessages Int            @map("total_messages")
  processed     Int            @default(0)
  failed        Int            @default(0)
  status        String
  fileName      String?        @map("file_name")
  fileFormat    String?        @map("file_format")
  errorSummary  Json?          @map("error_summary")
  startedAt     DateTime?      @map("started_at") @db.Timestamptz(6)
  completedAt   DateTime?      @map("completed_at") @db.Timestamptz(6)
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  user          User           @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  events        ContactEvent[]

  @@index([tenantId, status])
  @@index([createdBy])
  @@map("batch_jobs")
  @@schema("contact")
}

model ScheduledCallback {
  id                   String        @id @default(uuid()) @db.Uuid
  tenantId             String        @map("tenant_id") @db.Uuid
  customerId           String        @map("customer_id") @db.Uuid
  invoiceId            String?       @map("invoice_id") @db.Uuid
  sourceContactEventId String?       @map("source_contact_event_id") @db.Uuid
  scheduledAt          DateTime      @map("scheduled_at") @db.Timestamptz(6)
  type                 String        // CALLBACK | FOLLOW_UP
  reason               String?       // Motivo extra√≠do del resumen
  status               String        @default("PENDING") // PENDING | DONE | CANCELLED
  createdAt            DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)
  customer             Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  invoice              Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  sourceContactEvent   ContactEvent? @relation("ScheduledCallbackSource", fields: [sourceContactEventId], references: [id], onDelete: SetNull)
  tenant               Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([scheduledAt])
  @@index([customerId])
  @@map("scheduled_callbacks")
  @@schema("contact")
}

model DecisionItem {
  id         String    @id @default(uuid()) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  type       String
  severity   String
  status     String
  slaAt      DateTime? @map("sla_at") @db.Timestamptz(6)
  dataJson   Json      @map("data_json")
  createdBy  String?   @map("created_by") @db.Uuid
  resolvedBy String?   @map("resolved_by") @db.Uuid
  resolvedAt DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  creator    User?     @relation("CreatedBy", fields: [createdBy], references: [id])
  resolver   User?     @relation("ResolvedBy", fields: [resolvedBy], references: [id])
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([slaAt])
  @@map("decision_items")
  @@schema("ops")
}
